<?xml version="1.0" encoding="UTF-8" ?>
<config>
    <luceneMatchVersion>8.6.2</luceneMatchVersion>
    <lib dir="${solr.install.dir:../../../..}/dist/" regex="solr-analysis-extras-\d.*\.jar" />
    <lib dir="${solr.install.dir:../../../..}/contrib/analysis-extras/lib" regex="icu4j-\d.*\.jar" />
    <lib dir="${solr.install.dir:../../../..}/contrib/analysis-extras/lucene-libs" regex="lucene-analyzers-icu-\d.*\.jar" />

    <dataDir>${solr.data.dir:}</dataDir>

    <directoryFactory name="DirectoryFactory"
                      class="${solr.directoryFactory:solr.NRTCachingDirectoryFactory}" />

    <codecFactory class="solr.SchemaCodecFactory" />
    <schemaFactory class="ClassicIndexSchemaFactory" />

    <indexConfig>
        <lockType>${solr.lock.type:native}</lockType>
    </indexConfig>

    <jmx />

    <updateHandler class="solr.DirectUpdateHandler2">
        <updateLog>
            <str name="dir">${solr.ulog.dir:}</str>
        </updateLog>
        <autoCommit>
            <maxTime>${solr.autoCommit.maxTime:60000}</maxTime>
            <openSearcher>true</openSearcher>
        </autoCommit>
        <autoSoftCommit>
            <maxTime>${solr.autoSoftCommit.maxTime:-1}</maxTime>
        </autoSoftCommit>
    </updateHandler>

    <!-- auto-generate UUIDs when a document is indexed -->
    <updateProcessor class="solr.UUIDUpdateProcessorFactory" name="uuid">
        <str name="fieldName">id</str>
    </updateProcessor>

    <!-- auto-generate a timestamp when a document is indexed -->
    <updateProcessor class="solr.TimestampUpdateProcessorFactory" name="auto-timestamp">
        <str name="fieldName">indexed</str>
    </updateProcessor>

    <updateRequestProcessorChain name="process" default="true" processor="uuid,auto-timestamp">
        <processor class="solr.LogUpdateProcessorFactory" />
        <processor class="solr.RunUpdateProcessorFactory" />
    </updateRequestProcessorChain>

    <query>
        <maxBooleanClauses>1024</maxBooleanClauses>
        <filterCache class="solr.FastLRUCache"
                     size="512"
                     initialSize="512"
                     autowarmCount="256" />
        <queryResultCache class="solr.LRUCache"
                          size="4096"
                          initialSize="1024"
                          autowarmCount="512" />
        <documentCache class="solr.LRUCache"
                       size="4096"
                       initialSize="1024"
                       autowarmCount="512" />
        <cache name="perSegFilter"
               class="solr.search.LRUCache"
               size="10"
               initialSize="0"
               autowarmCount="10"
               regenerator="solr.NoOpRegenerator" />
        <enableLazyFieldLoading>true</enableLazyFieldLoading>
        <queryResultWindowSize>20</queryResultWindowSize>
        <queryResultMaxDocsCached>200</queryResultMaxDocsCached>
        <listener event="newSearcher" class="solr.QuerySenderListener">
            <arr name="queries" />
        </listener>
        <listener event="firstSearcher" class="solr.QuerySenderListener">
            <arr name="queries">
            </arr>
        </listener>
        <useColdSearcher>false</useColdSearcher>
    </query>

    <requestDispatcher handleSelect="false">
        <requestParsers enableRemoteStreaming="true"
                        multipartUploadLimitInKB="2048000"
                        formdataUploadLimitInKB="2048"
                        addHttpRequestToContext="false" />
        <httpCaching never304="true" />

    </requestDispatcher>

    <requestHandler name="/select" class="solr.SearchHandler">
        <lst name="defaults">
            <!-- <str name="echoParams">all</str>-->
            <int name="rows">20</int>
            <!-- <str name="q.op">AND</str>-->
            <!-- https://stackoverflow.com/a/29827605 "mm=100%" is the equivalent of q.op=AND -->
            <str name="defType">edismax</str>
            <arr name="mm">
                <str>4&lt;50%</str>
            </arr>
            <str name="mm.autoRelax">true</str>
            <str name="wt">json</str>
            <arr name="fl">
                <!-- return all fields, but specific json fields are run through the json transformer -->
                <str>*</str>
                <str>subjects_json:[json]</str>
                <str>holding_institutions_json:[json]</str>
                <str>material_groups_json:[json]</str>
                <str>rism_series_json:[json]</str>
                <str>creator_json:[json]</str>
                <str>relationships_json:[json]</str>
                <str>source_membership_json:[json]</str>
                <str>related_people_json:[json]</str>
                <str>related_places_json:[json]</str>
                <str>external_resources_json:[json]</str>
                <str>variant_names_json:[json]</str>
                <str>related_institutions_json:[json]</str>
                <str>liturgical_festivals_json:[json]</str>
                <str>scoring_json:[json]</str>
                <str>minimal_mss_holding_json:[json]</str>
                <str>dramatic_roles_json:[json]</str>
                <str>location_of_performance_json:[json]</str>
                <str>standard_titles_json:[json]</str>
                <str>additional_titles_json:[json]</str>
                <str>works_catalogue_json:[json]</str>
                <str>bibliographic_references_json:[json]</str>
                <str>secondary_literature_json:[json]</str>
            </arr>
            <arr name="qf">
                <str>rism_id_wstok</str>
                <str>siglum_kw^5</str>
                <str>identifiers_wstok^10</str>
                <str>identifiers_ft</str>
                <str>title_composer_ft^5</str>
                <str>publication_info_ft^2</str>
                <str>people_names_ft^2</str>
                <str>subjects_ft^5</str>
                <str>notes_ft^2</str>
                <str>institutions_ft</str>
                <str>location_ft</str>
                <str>roles_ft</str>
                <str>source_people_names_ft</str>
                <str>scoring_summary_ti</str>
            </arr>
            <int name="ps">10</int>
            <int name="qs">10</int>
            <arr name="pf">
                <str>notes_ft</str>
                <str>title_composer_ft</str>
            </arr>
            <arr name="pf2">
                <str>notes_ft</str>
                <str>title_composer_ft</str>
            </arr>
            <arr name="pf3">
                <str>notes_ft</str>
                <str>title_composer_ft</str>
            </arr>
            <arr name="boost">
                <!-- source count is a very crude but effective method of determining
                     more or less important people and institutions.
                -->
                <str>scale(field(source_count_i), 1, 100)</str>
            </arr>
        </lst>
    </requestHandler>

    <!-- <requestHandler name="/iiif" class="solr.SearchHandler">
        <lst name="defaults">
            <str name="echoParams">explicit</str>
            <str name="df">text</str>
            <str name="wt">json</str>
        </lst>
    </requestHandler> -->

    <requestHandler name="/query" class="solr.SearchHandler">
        <lst name="defaults">
            <str name="echoParams">explicit</str>
            <str name="wt">json</str>
            <str name="indent">true</str>
            <str name="df">text</str>
        </lst>
    </requestHandler>

    <!--    <searchComponent name="spellcheck" class="solr.SpellCheckComponent">-->
    <!--        <str name="queryAnalyzerFieldType">text_spell</str>-->
    <!--        <lst name="spellchecker">-->
    <!--            <str name="name">direct</str>-->
    <!--            <str name="classname">solr.DirectSolrSpellChecker</str>-->
    <!--            <str name="distanceMeasure">org.apache.lucene.search.spell.LuceneLevenshteinDistance</str>-->
    <!--            <str name="comparatorClass">score</str>-->
    <!--            <int name="maxEdits">2</int>-->
    <!--            <int name="minPrefix">1</int>-->
    <!--            <int name="minQueryLength">3</int>-->
    <!--            <str name="field">spell_sp</str>-->
    <!--            <str name="buildOnCommit">true</str>-->
    <!--        </lst>-->
    <!--        <lst name="spellchecker">-->
    <!--            <str name="name">wordbreak</str>-->
    <!--            <str name="classname">solr.WordBreakSolrSpellChecker</str>-->
    <!--            <str name="field">spell_sp</str>-->
    <!--            <str name="combineWords">true</str>-->
    <!--            <str name="breakWords">true</str>-->
    <!--            <int name="maxChanges">10</int>-->
    <!--        </lst>-->
    <!--    </searchComponent>-->

    <!-- uncomment if needed; used for testing -->
    <!--
    <lib dir="${solr.install.dir:../../../..}/dist/" regex="solr-dataimporthandler-.*\.jar" />
    <requestHandler name="/dataimport" class="org.apache.solr.handler.dataimport.DataImportHandler">
        <lst name="defaults">
            <str name="config">data-config-ingest.xml</str>
        </lst>
    </requestHandler>
    -->
</config>
